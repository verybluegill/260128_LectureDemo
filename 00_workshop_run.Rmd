---
title: "Schaefer / HCR / MSE Workshop"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1) 準備

```{r}
# 乱数の再現性を固定
rm(list = ls())
set.seed(123)
options(stringsAsFactors = FALSE)

if (!requireNamespace("ggplot2", quietly = TRUE)) {
  stop("ggplot2 が未インストールです。")
}
library(ggplot2)

# 関数の読み込み
source("R/om_schaefer.R")
source("R/obs_cpue_lognormal.R")
source("R/fit_schaefer_ml.R")
source("R/hcr_hockey_stick.R")
source("R/hcr_new2kei_2k.R")
source("R/metrics_plots.R")

# 出力フォルダ
out_fig <- file.path("output", "fig")
out_tab <- file.path("output", "tab")
dir.create(out_fig, recursive = TRUE, showWarnings = FALSE)
dir.create(out_tab, recursive = TRUE, showWarnings = FALSE)

# 高速化の設定（Rcppが無い場合はR版にフォールバック）
use_cpp <- TRUE
if (use_cpp && !requireNamespace("Rcpp", quietly = TRUE)) {
  message("Rcpp が未インストールのため、use_cpp = FALSE にします。")
  use_cpp <- FALSE
}
```

# 2) 1ケースのデータ生成（TTYear=50, sigma=0.1）

```{r}
# 推奨パラメータ（推定安定性とHCRのバランス重視）
TTYear <- 50
r <- 0.6
K <- 1000
D1 <- 0.7
B1 <- D1 * K
CR <- 0.2
q <- 0.05
sigma_CPUE <- 0.1
# Fの年変動（平均CRを保つ対数正規）
sigma_F <- 0.3
F_mult <- rlnorm(TTYear, meanlog = -0.5 * sigma_F^2, sdlog = sigma_F)

# OM（Schaefer）で真の資源量と漁獲を生成
om <- om_schaefer_sim(TTYear = TTYear, r = r, K = K, B1 = B1, CR = CR, CR_mult = F_mult)
B_true <- om$B_true
Catch <- om$C_true

# Index観測（対数正規、バイアス補正あり）
obs <- obs_cpue_lognormal(B_true, q, sigma_CPUE)
index_obs <- obs$I_obs

Year <- 1975:(1975 + TTYear - 1)

# データまとめ
case_data <- data.frame(
  Year = Year,
  Biomass = B_true,
  Catch = Catch,
  Index = index_obs
)

# 図を保存
save_png(file.path(out_fig, "case_timeseries.png"), width = 900, height = 900, plot_fun = function() {
  plot_ts_case(Year, B_true, Catch, index_obs, main_title = "Single-case OM + Obs")
})

# 画面にも表示（Rmd用）
plot_ts_case(Year, B_true, Catch, index_obs, main_title = "Single-case OM + Obs")
```

# 3) Schaefer推定（最尤）

```{r}
# 観測漁獲（過小報告なしの基本ケース）
Catch_obs <- Catch

# 推定（C++版が使えるなら高速化）
fit <- if (use_cpp) fit_schaefer_ml_cpp(Catch_obs, index_obs) else fit_schaefer_ml(Catch_obs, index_obs)

# 推定の成否
cat("Fit success:", fit$success, "  converged:", fit$converged, "\n")

# 真値と推定値の比較（時系列）
save_png(file.path(out_fig, "fit_biomass.png"), width = 900, height = 600, plot_fun = function() {
  plot_true_vs_hat(Year, B_true, fit$B_hat, main_title = "True vs Estimated Biomass")
})

# 画面にも表示（Rmd用）
plot_true_vs_hat(Year, B_true, fit$B_hat, main_title = "True vs Estimated Biomass")

# パラメータ表（真値と推定値）
fit_table <- data.frame(
  parameter = c("r", "K", "q", "B1", "sigma_I"),
  true = c(r, K, q, B1, sigma_CPUE),
  estimate = c(fit$par["r"], fit$par["K"], fit$par["q"], fit$par["B1"], fit$par["sigma_I"])
)
fit_table
write.csv(fit_table, file.path(out_tab, "fit_params.csv"), row.names = FALSE)
```
# 4) 簡易感度解析（最小限）

```{r}
# わかりやすさ優先で、最小限の設定だけ動かす
do_sensitivity <- TRUE

if (do_sensitivity) {
# TRUEで実行（必要ならFALSEにする）
  do_sens_TT <- TRUE          # 時系列の長さ
  do_sens_sigma <- TRUE       # sigmaの違い
  do_sens_catch_under <- TRUE # Catch過小報告

  # 感度解析用：1ケース分の推定B時系列を作る
  run_sens_ts <- function(TT, sigma_CPUE, catch_report = 1, seed = NULL) {
    if (!is.null(seed)) set.seed(seed)
    F_mult_tmp <- rlnorm(TT, meanlog = -0.5 * sigma_F^2, sdlog = sigma_F)
    om_tmp <- om_schaefer_sim(TTYear = TT, r = r, K = K, B1 = D1 * K, CR = CR, CR_mult = F_mult_tmp)
    obs_tmp <- obs_cpue_lognormal(om_tmp$B_true, q, sigma_CPUE)
    C_obs_tmp <- om_tmp$C_true * catch_report
    fit_tmp <- if (use_cpp) fit_schaefer_ml_cpp(C_obs_tmp, obs_tmp$I_obs) else fit_schaefer_ml(C_obs_tmp, obs_tmp$I_obs)

    if (isTRUE(fit_tmp$success)) {
      B_hat_tmp <- fit_tmp$B_hat
    } else {
      B_hat_tmp <- rep(NA_real_, TT)
    }

    data.frame(
      Year = 1:TT,
      B_hat = B_hat_tmp,
      B_true = om_tmp$B_true,
      TTYear = TT,
      sigma_CPUE = sigma_CPUE,
      catch_report = catch_report
    )
  }

  sens_ts_list <- list()
  idx <- 1

  if (do_sens_TT) {
    # 時系列の長さ違い
    TT_vec <- c(30, 50)
    for (TT in TT_vec) {
      df_tmp <- run_sens_ts(TT, sigma_CPUE = 0.1, catch_report = 1, seed = 100 + TT)
      df_tmp$Group <- "TTYear"
      df_tmp$Scenario <- paste0("TTYear=", TT)
      sens_ts_list[[idx]] <- df_tmp
      idx <- idx + 1
    }
  }

  if (do_sens_sigma) {
    # sigmaの違い
    sigma_vec <- c(0.10, 0.30)
    for (sg in sigma_vec) {
      df_tmp <- run_sens_ts(TTYear, sigma_CPUE = sg, catch_report = 1, seed = 200 + round(sg * 100))
      df_tmp$Group <- "Sigma"
      df_tmp$Scenario <- paste0("sigma=", sg)
      sens_ts_list[[idx]] <- df_tmp
      idx <- idx + 1
    }
  }

  if (do_sens_catch_under) {
    # Catch過小報告（例：70%報告）
    report_vec <- c(1.0, 0.7)
    for (rp in report_vec) {
      df_tmp <- run_sens_ts(TTYear, sigma_CPUE = 0.1, catch_report = rp, seed = 300 + round(rp * 100))
      df_tmp$Group <- "CatchUnder"
      df_tmp$Scenario <- paste0("report=", rp)
      sens_ts_list[[idx]] <- df_tmp
      idx <- idx + 1
    }
  }

  sens_ts_df <- do.call(rbind, sens_ts_list)

  # TTYear
  if (do_sens_TT) {
    df_tt <- subset(sens_ts_df, Group == "TTYear")
    save_png(file.path(out_fig, "sensitivity_ts_TTYear.png"), width = 900, height = 600, plot_fun = function() {
      p_tt <- ggplot(df_tt, aes(x = Year, y = B_hat, color = Scenario)) +
        geom_line(size = 1) +
        labs(x = "Year", y = "Estimated biomass", title = "Sensitivity: TTYear") +
        theme_minimal(base_size = 12)
      print(p_tt)
    })
    p_tt <- ggplot(df_tt, aes(x = Year, y = B_hat, color = Scenario)) +
      geom_line(size = 1) +
      labs(x = "Year", y = "Estimated biomass", title = "Sensitivity: TTYear") +
      theme_minimal(base_size = 12)
    print(p_tt)
  }

  # sigma
  if (do_sens_sigma) {
    df_sg <- subset(sens_ts_df, Group == "Sigma")
    save_png(file.path(out_fig, "sensitivity_ts_sigma.png"), width = 900, height = 600, plot_fun = function() {
      p_sg <- ggplot(df_sg, aes(x = Year, y = B_hat, color = Scenario)) +
        geom_line(size = 1) +
        labs(x = "Year", y = "Estimated biomass", title = "Sensitivity: sigma") +
        theme_minimal(base_size = 12)
      print(p_sg)
    })
    p_sg <- ggplot(df_sg, aes(x = Year, y = B_hat, color = Scenario)) +
      geom_line(size = 1) +
      labs(x = "Year", y = "Estimated biomass", title = "Sensitivity: sigma") +
      theme_minimal(base_size = 12)
    print(p_sg)
  }

  # Catch過小報告
  if (do_sens_catch_under) {
    df_cu <- subset(sens_ts_df, Group == "CatchUnder")
    save_png(file.path(out_fig, "sensitivity_ts_catch_under.png"), width = 900, height = 600, plot_fun = function() {
      p_cu <- ggplot(df_cu, aes(x = Year, y = B_hat, color = Scenario)) +
        geom_line(size = 1) +
        labs(x = "Year", y = "Estimated biomass", title = "Sensitivity: underreported catch") +
        theme_minimal(base_size = 12)
      print(p_cu)
    })
    p_cu <- ggplot(df_cu, aes(x = Year, y = B_hat, color = Scenario)) +
      geom_line(size = 1) +
      labs(x = "Year", y = "Estimated biomass", title = "Sensitivity: underreported catch") +
      theme_minimal(base_size = 12)
    print(p_cu)
  }
} else {
  cat("簡易感度解析をスキップしました。\n")
}
```


# 5) HCRの形の図示（Hockey と Type2）

```{r}
# 教材として切り替えやすいようにKは固定値を使う
K_ref <- K

# Hockey-stick
save_png(file.path(out_fig, "hcr_hockey_shape.png"), width = 900, height = 600, plot_fun = function() {
  plot_hockey_shape(K_ref = K_ref, beta = 0.8, Bban_ratio = 0.3, Blim_ratio = 0.6)
})
plot_hockey_shape(K_ref = K_ref, beta = 0.8, Bban_ratio = 0.3, Blim_ratio = 0.6)

# Type2
save_png(file.path(out_fig, "hcr_type2_shape.png"), width = 900, height = 600, plot_fun = function() {
  plot_2k_shape(AAV_t = 0.2, BT = 0.75, PL = 0.7, PB = 0.0,
                beta_2k = 0.6, delta = 0.3, lambda = 0.3)
})
plot_2k_shape(AAV_t = 0.2, BT = 0.75, PL = 0.7, PB = 0.0,
              beta_2k = 0.6, delta = 0.3, lambda = 0.3)
```

# 6) MSEの流れを手動で確認（教育用）

```{r}
# MSEの流れ：OM -> Obs -> Assess -> HCR -> 次年Catch
management_start <- 10
# Fの年変動（管理開始前の実漁獲に反映）
F_mult_pre <- rlnorm(TTYear, meanlog = -0.5 * sigma_F^2, sdlog = sigma_F)

# まずは管理開始年まで、手動で流れを確認
TT_demo <- management_start
B_demo <- rep(NA_real_, TT_demo)
C_demo <- rep(NA_real_, TT_demo)
I_demo <- rep(NA_real_, TT_demo)
Cobs_demo <- rep(NA_real_, TT_demo)

# 初期値
B_demo[1] <- B1
C_demo[1] <- CR * F_mult_pre[1] * B_demo[1]

for (t in 1:(TT_demo - 1)) {
  # 1) OM：真の資源動態
  B_demo[t + 1] <- om_step_schaefer(B_demo[t], C_demo[t], r, K)

  # 2) Obs：Index観測
  obs_t <- obs_cpue_lognormal(B_demo[t], q, sigma_CPUE)
  I_demo[t] <- obs_t$I_obs

  # 漁獲は観測可能と仮定
  Cobs_demo[t] <- C_demo[t]

  # 3) Assessと4) HCRは管理開始前なので実施しない
  C_demo[t + 1] <- CR * F_mult_pre[t + 1] * B_demo[t + 1]
}

# 管理開始年（TT_demo）で評価とHCRを実施
obs_last <- obs_cpue_lognormal(B_demo[TT_demo], q, sigma_CPUE)
I_demo[TT_demo] <- obs_last$I_obs
Cobs_demo[TT_demo] <- C_demo[TT_demo]

assess_demo <- if (use_cpp) fit_schaefer_ml_cpp(Cobs_demo, I_demo) else fit_schaefer_ml(Cobs_demo, I_demo)
B_hat_demo <- assess_demo$B_hat[TT_demo]

# Hockey-stickのHCRを適用
Bban_demo <- 0.3 * K
Blim_demo <- 0.6 * K
h_demo <- hcr_hockey_stick(B_hat_demo, beta = 0.8, Bban = Bban_demo, Blim = Blim_demo)
C_next_demo <- h_demo$C_next

cat("Demo year:", TT_demo, "  B_hat:", round(B_hat_demo, 2), "  C_next:", round(C_next_demo, 2), "\n")
```
# 7) MSEをforループで回す（Hockey vs Type2）

```{r}
# CapはHCRパラメータで代替（直接capしない）
beta_hcr <- 0.6  # 例：最大漁獲率（cap相当）
abc_ratio_cap <- 1.5  # 例：Type2のABC/Cbar上限相当
clamp_2k <- log(abc_ratio_cap)

# ------- hockey -------
B_true_h <- rep(NA_real_, TTYear)
C_true_h <- rep(NA_real_, TTYear)
C_obs_h <- rep(NA_real_, TTYear)
I_obs_h <- rep(NA_real_, TTYear)
B_hat_h <- rep(NA_real_, TTYear)
fit_success_h <- rep(FALSE, TTYear)

B_true_h[1] <- B1
C_true_h[1] <- CR * F_mult_pre[1] * B_true_h[1]

for (t in 1:(TTYear - 1)) {
  # 1) OM
  B_true_h[t + 1] <- om_step_schaefer(B_true_h[t], C_true_h[t], r, K)

  # 2) Obs
  obs_t <- obs_cpue_lognormal(B_true_h[t], q, sigma_CPUE)
  I_obs_h[t] <- obs_t$I_obs
  C_obs_h[t] <- C_true_h[t]

  # 3) Assess + 4) HCR
  if (t >= management_start) {
    assess <- if (use_cpp) fit_schaefer_ml_cpp(C_obs_h[1:t], I_obs_h[1:t]) else fit_schaefer_ml(C_obs_h[1:t], I_obs_h[1:t])

    if (isTRUE(assess$success) && is.finite(assess$B_hat[t])) {
      fit_success_h[t] <- TRUE
      B_hat_h[t] <- assess$B_hat[t]
    } else {
      # 失敗時は真値にフォールバック（教材用の安定化）
      B_hat_h[t] <- B_true_h[t]
    }

    # Hockey-stickは固定値を使う
    Bban <- 0.3 * K
    Blim <- 0.6 * K
    h_out <- hcr_hockey_stick(B_hat_h[t], beta = beta_hcr, Bban = Bban, Blim = Blim)
    C_next <- h_out$C_next


    # 失敗時のガード
    if (!is.finite(C_next) || C_next < 0) C_next <- C_true_h[t]
    C_true_h[t + 1] <- C_next
  } else {
    # 管理開始前はFの揺らぎを反映
    C_true_h[t + 1] <- CR * F_mult_pre[t + 1] * B_true_h[t + 1]
  }
}

# 最終年の観測
obs_last <- obs_cpue_lognormal(B_true_h[TTYear], q, sigma_CPUE)
I_obs_h[TTYear] <- obs_last$I_obs
C_obs_h[TTYear] <- C_true_h[TTYear]

# ------- Type2 -------
B_true_2k <- rep(NA_real_, TTYear)
C_true_2k <- rep(NA_real_, TTYear)
C_obs_2k <- rep(NA_real_, TTYear)
I_obs_2k <- rep(NA_real_, TTYear)
B_hat_2k <- rep(NA_real_, TTYear)
fit_success_2k <- rep(FALSE, TTYear)

B_true_2k[1] <- B1
C_true_2k[1] <- CR * F_mult_pre[1] * B_true_2k[1]

for (t in 1:(TTYear - 1)) {
  # 1) OM
  B_true_2k[t + 1] <- om_step_schaefer(B_true_2k[t], C_true_2k[t], r, K)

  # 2) Obs
  obs_t <- obs_cpue_lognormal(B_true_2k[t], q, sigma_CPUE)
  I_obs_2k[t] <- obs_t$I_obs
  C_obs_2k[t] <- C_true_2k[t]

  # 3) Assess + 4) HCR
  if (t >= management_start) {
    assess <- if (use_cpp) fit_schaefer_ml_cpp(C_obs_2k[1:t], I_obs_2k[1:t]) else fit_schaefer_ml(C_obs_2k[1:t], I_obs_2k[1:t])

    if (isTRUE(assess$success)) {
      fit_success_2k[t] <- TRUE
      B_hat_2k[t] <- assess$B_hat[t]
    }

    h_out <- hcr_new2kei_2k(C_obs_2k[1:t], I_obs_2k[1:t],
                            n = 5, BT = 0.75, PL = 0.7, PB = 0.0,
                            beta_2k = beta_hcr, delta = 0.3, lambda = 0.3, clamp = clamp_2k)
    C_next <- h_out$ABC_t


    # 失敗時のガード
    if (!is.finite(C_next) || C_next < 0) C_next <- C_true_2k[t]
    C_true_2k[t + 1] <- C_next
  } else {
    # 管理開始前はFの揺らぎを反映
    C_true_2k[t + 1] <- CR * F_mult_pre[t + 1] * B_true_2k[t + 1]
  }
}

# 最終年の観測
obs_last <- obs_cpue_lognormal(B_true_2k[TTYear], q, sigma_CPUE)
I_obs_2k[TTYear] <- obs_last$I_obs
C_obs_2k[TTYear] <- C_true_2k[TTYear]

# 指標計算
mse_sum_h <- calc_mse_metrics(B_true_h, C_true_h, K_true = K, management_start = management_start)
mse_sum_h$HCR <- "hockey"

mse_sum_2k <- calc_mse_metrics(B_true_2k, C_true_2k, K_true = K, management_start = management_start)
mse_sum_2k$HCR <- "Type2"

mse_summary <- rbind(mse_sum_h, mse_sum_2k)
mse_summary
write.csv(mse_summary, file.path(out_tab, "mse_summary.csv"), row.names = FALSE)

# MSE可視化（参照デザインに合わせて簡略化）
plot_mse_simple <- function(Year, B_true_h, B_true_2k, C_true_h, C_true_2k, I_obs_h, I_obs_2k) {
  df_bio <- rbind(
    data.frame(Year = Year, Biomass = B_true_h, Index = I_obs_h * 20, HCR = "Hockey"),
    data.frame(Year = Year, Biomass = B_true_2k, Index = I_obs_2k * 20, HCR = "Type2")
  )

  p_bio <- ggplot(df_bio, aes(x = Year)) +
    ylab("Scaled abundance indices and Biomass") + xlab("") +
    geom_bar(aes(y = Biomass), stat = "identity") +
    geom_line(aes(y = Index, col = "Index*20")) +
    geom_point(aes(y = Index, col = "Index*20")) +
    scale_x_continuous(expand = c(0, 0), limits = c(min(Year) - 0.5, max(Year) + 0.5),
                       breaks = seq(min(Year), max(Year), 5)) +
    scale_color_manual(values = c("Index*20" = "darkorange"), name = NULL) +
    facet_wrap(~HCR, ncol = 1) +
    theme_minimal(base_size = 12)

  df_catch <- rbind(
    data.frame(Year = Year, Catch = C_true_h, HCR = "Hockey"),
    data.frame(Year = Year, Catch = C_true_2k, HCR = "Type2")
  )

  p_catch <- ggplot(df_catch, aes(x = Year)) +
    ylab("Catch") + xlab("") +
    geom_bar(aes(y = Catch), stat = "identity") +
    scale_x_continuous(expand = c(0, 0), limits = c(min(Year) - 0.5, max(Year) + 0.5),
                       breaks = seq(min(Year), max(Year), 5)) +
    facet_wrap(~HCR, ncol = 1) +
    theme_minimal(base_size = 12)

  draw_gg_stack(list(p_bio, p_catch), heights = c(2, 1.5))
}

# 図を保存
save_png(file.path(out_fig, "mse_timeseries_compare.png"), width = 900, height = 900, plot_fun = function() {
  plot_mse_simple(Year, B_true_h, B_true_2k, C_true_h, C_true_2k, I_obs_h, I_obs_2k)
})

# 画面にも表示（Rmd用）
plot_mse_simple(Year, B_true_h, B_true_2k, C_true_h, C_true_2k, I_obs_h, I_obs_2k)
```
# 8) 出力ファイルの一覧

```{r}
cat("\n--- output/fig ---\n")
print(list.files(out_fig, full.names = TRUE))
cat("\n--- output/tab ---\n")
print(list.files(out_tab, full.names = TRUE))
```













