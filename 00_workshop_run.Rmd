---
title: "Schaefer / HCR / MSE Workshop"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1) 準備

```{r}
rm(list = ls())
set.seed(0128)
options(stringsAsFactors = FALSE)

if (!requireNamespace("ggplot2", quietly = TRUE)) {
  stop("ggplot2 が未インストールです。")
}
library(ggplot2)

# 関数の読み込み
source("R/om_schaefer.R")
source("R/obs_cpue_lognormal.R")
source("R/fit_schaefer_ml.R")
source("R/hcr_hockey_stick.R")
source("R/hcr_new2kei_2k.R")
source("R/metrics_plots.R")
source("R/mse_loop.R")

# 高速化の設定（Rcppが無い場合はR版にフォールバック）
use_cpp <- TRUE
if (use_cpp && !requireNamespace("Rcpp", quietly = TRUE)) {
  message("Rcpp が未インストールのため、use_cpp = FALSE にします。")
  use_cpp <- FALSE
}
```

# 2) 1ケースのデータ生成（TTYear=50, sigma=0.1）

```{r}
# パラメータ
TTYear <- 50
r <- 0.6
K <- 1000
D1 <- 0.7
B1 <- D1 * K
CR <- 0.2
q <- 0.05
sigma_CPUE <- 0.1
# Fの年変動
sigma_F <- 0.3
F_mult <- rlnorm(TTYear, meanlog = -0.5 * sigma_F^2, sdlog = sigma_F)

# OM（Schaefer）で真の資源量と漁獲を生成
om <- om_schaefer_sim(TTYear = TTYear, r = r, K = K, B1 = B1, CR = CR, CR_mult = F_mult)
B_true <- om$B_true
Catch <- om$C_true

# Index観測（対数正規、バイアス補正あり）
obs <- obs_cpue_lognormal(B_true, q, sigma_CPUE)
index_obs <- obs$I_obs

Year <- 1975:(1975 + TTYear - 1)

# データまとめ
case_data <- data.frame(
  Year = Year,
  Biomass = B_true,
  Catch = Catch,
  Index = index_obs
)

# 画面にも表示（Rmd用）
plot_ts_case(Year, B_true, Catch, index_obs, main_title = "Single-case OM + Obs")
```

# 3) Schaeferで最尤推定

```{r}
# 観測漁獲
Catch_obs <- Catch

# 推定
fit <- if (use_cpp) fit_schaefer_ml_cpp(Catch_obs, index_obs) else fit_schaefer_ml(Catch_obs, index_obs)

# 推定の成否
cat("Fit success:", fit$success, "  converged:", fit$converged, "\n")

# 真値と推定値の比較
plot_true_vs_hat(Year, B_true, fit$B_hat, main_title = "True vs Estimated Biomass")

# パラメータ表（真値と推定値）
fit_table <- data.frame(
  parameter = c("r", "K", "q", "B1", "sigma_I"),
  true = c(r, K, q, B1, sigma_CPUE),
  estimate = c(fit$par["r"], fit$par["K"], fit$par["q"], fit$par["B1"], fit$par["sigma_I"])
)
fit_table
```
# 4) 簡易感度解析

```{r}
do_sensitivity <- TRUE

if (do_sensitivity) {
# TRUEで実行（必要ならFALSEにする）
  do_sens_TT <- TRUE          # 時系列の長さ
  do_sens_sigma <- TRUE       # sigmaの違い
  do_sens_catch_under <- TRUE # Catch過小報告

  # 感度解析用：1ケース分の推定B時系列を作る
  run_sens_ts <- function(TT, sigma_CPUE, catch_report = 1, seed = NULL) {
    if (!is.null(seed)) set.seed(seed)
    B_true_tmp <- B_true[1:TT]
    C_true_tmp <- Catch[1:TT]
    obs_tmp <- obs_cpue_lognormal(B_true_tmp, q, sigma_CPUE)
    C_obs_tmp <- C_true_tmp * catch_report
    fit_tmp <- if (use_cpp) fit_schaefer_ml_cpp(C_obs_tmp, obs_tmp$I_obs) else fit_schaefer_ml(C_obs_tmp, obs_tmp$I_obs)

    if (isTRUE(fit_tmp$success)) {
      B_hat_tmp <- fit_tmp$B_hat
    } else {
      B_hat_tmp <- rep(NA_real_, TT)
    }

    data.frame(
      Year = 1:TT,
      B_hat = B_hat_tmp,
      B_true = B_true_tmp,
      TTYear = TT,
      sigma_CPUE = sigma_CPUE,
      catch_report = catch_report
    )
  }

  sens_ts_list <- list()
  idx <- 1

  if (do_sens_TT) {
    # 時系列の長さ違い
    TT_vec <- c(30, 50)
    for (TT in TT_vec) {
      df_tmp <- run_sens_ts(TT, sigma_CPUE = 0.1, catch_report = 1, seed = 100 + TT)
      df_tmp$Group <- "TTYear"
      df_tmp$Scenario <- paste0("TTYear=", TT)
      sens_ts_list[[idx]] <- df_tmp
      idx <- idx + 1
    }
  }

  if (do_sens_sigma) {
    # sigmaの違い
    sigma_vec <- c(0.10, 0.30)
    for (sg in sigma_vec) {
      df_tmp <- run_sens_ts(TTYear, sigma_CPUE = sg, catch_report = 1, seed = 200 + round(sg * 100))
      df_tmp$Group <- "Sigma"
      df_tmp$Scenario <- paste0("sigma=", sg)
      sens_ts_list[[idx]] <- df_tmp
      idx <- idx + 1
    }
  }

  if (do_sens_catch_under) {
    # Catch過小報告（例：70%報告）
    report_vec <- c(1.0, 0.7)
    for (rp in report_vec) {
      df_tmp <- run_sens_ts(TTYear, sigma_CPUE = 0.1, catch_report = rp, seed = 300 + round(rp * 100))
      df_tmp$Group <- "CatchUnder"
      df_tmp$Scenario <- paste0("report=", rp)
      sens_ts_list[[idx]] <- df_tmp
      idx <- idx + 1
    }
  }

  sens_ts_df <- do.call(rbind, sens_ts_list)

  # TTYear
  if (do_sens_TT) {
    df_tt <- subset(sens_ts_df, Group == "TTYear")
  
    # 追加: True用のデータ（Scenarioを"True"に固定して色凡例に載せる）
    df_tt_true <- df_tt
    df_tt_true$Scenario <- "True"   # ←追加（凡例に True を出すため）
  
    p_tt <- ggplot() +
      geom_line(data = df_tt, aes(x = Year, y = B_hat, color = Scenario), size = 1) +
      geom_line(data = df_tt_true, aes(x = Year, y = B_true, color = Scenario), size = 1.1) +
      labs(x = "Year", y = "Biomass", title = "Sensitivity: TTYear") +
      scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.05))) +  # ←追加
      theme_minimal(base_size = 12)
    print(p_tt)
  }

  # sigma
  if (do_sens_sigma) {
    df_sg <- subset(sens_ts_df, Group == "Sigma")
    df_sg_true <- df_sg
    df_sg_true$Scenario <- "True"  # ←追加
  
    p_sg <- ggplot() +
      geom_line(data = df_sg, aes(x = Year, y = B_hat, color = Scenario), size = 1) +
      geom_line(data = df_sg_true, aes(x = Year, y = B_true, color = Scenario), size = 1.1) +
      labs(x = "Year", y = "Biomass", title = "Sensitivity: sigma") +
      scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.05))) +  # ←追加
      theme_minimal(base_size = 12)
    print(p_sg)
  }

  # Catch過小報告
  if (do_sens_catch_under) {
    df_cu <- subset(sens_ts_df, Group == "CatchUnder")
    df_cu_true <- df_cu
    df_cu_true$Scenario <- "True"  # ←追加
  
    p_cu <- ggplot() +
      geom_line(data = df_cu, aes(x = Year, y = B_hat, color = Scenario), size = 1) +
      geom_line(data = df_cu_true, aes(x = Year, y = B_true, color = Scenario), size = 1.1) +
      labs(x = "Year", y = "Biomass", title = "Sensitivity: underreported catch") +
      scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.05))) +  # ←追加
      theme_minimal(base_size = 12)
    print(p_cu)
  }
} else {
  cat("簡易感度解析をスキップしました。\n")
}
```


# 5) HCRの形の図示（Hockey と Type2）

```{r}
# Hockey-stick
plot_hockey_shape(K_ref = K, beta = 0.8, Bban_ratio = 0.3, Blim_ratio = 0.6)

# Type2
plot_2k_shape(AAV_t = 0.2, BT = 0.8, PL = 0.7, PB = 0.0,
              beta_2k = 0.5, delta = 0.4, lambda = 0.4)
```

# 6) MSE（Hockey vs Type2）

```{r fig.width=11, fig.height=8}
# ---- HCRパラメータ----
beta_hcr <- 0.8          
beta_2k <- 0.25
abc_ratio_cap <- 1.5
clamp_2k <- log(abc_ratio_cap)
management_start <- 10

# (1) Hockey（推定）
h_out <- mse_loop(
  TTYear = TTYear, r = r, K = K, B1 = B1, q = q, sigma_CPUE = sigma_CPUE,
  CR_init = CR, management_start = management_start,
  hcr_type = "hockey",
  hcr_par = list(beta = beta_hcr, Bban_ratio = 0.3, Blim_ratio = 0.6, K_ref_type = "estimated"),
  use_cpp = use_cpp
)

# (2) Type2
t2_out <- mse_loop(
  TTYear = TTYear, r = r, K = K, B1 = B1, q = q, sigma_CPUE = sigma_CPUE,
  CR_init = CR, management_start = management_start,
  hcr_type = "2k",
  hcr_par = list(n = 5, BT = 0.75, PL = 0.7, PB = 0.0,
                 beta_2k = beta_2k, delta = 0.3, lambda = 0.3, clamp = clamp_2k),
  use_cpp = use_cpp
)

# ---- 指標 ----
mse_sum_h  <- calc_mse_metrics(h_out$B_true,  h_out$C_true,  K_true = K, management_start = management_start)
mse_sum_h$HCR <- "Hockey (estimated Fmsy)"

mse_sum_2k <- calc_mse_metrics(t2_out$B_true, t2_out$C_true, K_true = K, management_start = management_start)
mse_sum_2k$HCR <- "Type2"

mse_summary <- rbind(mse_sum_h, mse_sum_2k)
mse_summary

# ---- 図（Biomass+Index と Catch の縦2段、2シナリオ比較）----
plot_mse_2 <- function(Year, h_out, t2_out, index_scale = 20) {

  df_bio <- rbind(
    data.frame(Year = Year, Biomass = h_out$B_true,  Index = h_out$I_obs  * index_scale, HCR = "Hockey (estimated Fmsy)"),
    data.frame(Year = Year, Biomass = t2_out$B_true, Index = t2_out$I_obs * index_scale, HCR = "Type2")
  )

  p_bio <- ggplot(df_bio, aes(x = Year)) +
    ylab("Scaled abundance indices and True Biomass") + xlab("") +
    geom_bar(aes(y = Biomass), stat = "identity") +
    geom_line(aes(y = Index, col = "Index*20")) +
    geom_point(aes(y = Index, col = "Index*20")) +
    scale_x_continuous(expand = c(0, 0),
                       limits = c(min(Year) - 0.5, max(Year) + 0.5),
                       breaks = seq(min(Year), max(Year), 5)) +
    scale_color_manual(values = c("Index*20" = "darkorange"), name = NULL) +
    facet_wrap(~HCR, ncol = 1) +
    theme_minimal(base_size = 12)

  df_catch <- rbind(
    data.frame(Year = Year, Catch = h_out$C_true,  HCR = "Hockey (estimated Fmsy)"),
    data.frame(Year = Year, Catch = t2_out$C_true, HCR = "Type2")
  )

  p_catch <- ggplot(df_catch, aes(x = Year)) +
    ylab("Catch") + xlab("") +
    geom_bar(aes(y = Catch), stat = "identity") +
    scale_x_continuous(expand = c(0, 0),
                       limits = c(min(Year) - 0.5, max(Year) + 0.5),
                       breaks = seq(min(Year), max(Year), 5)) +
    facet_wrap(~HCR, ncol = 1) +
    theme_minimal(base_size = 12)

  draw_gg_stack(list(p_bio, p_catch), heights = c(2, 1.5))
}

plot_mse_estimated <- function(Year, h_out, t2_out, index_scale = 20) {

  df_bio_hat <- rbind(
    data.frame(Year = Year, Biomass = h_out$B_hat,  Index = h_out$I_obs  * index_scale, HCR = "Hockey (estimated Fmsy)"),
    data.frame(Year = Year, Biomass = t2_out$B_hat, Index = t2_out$I_obs * index_scale, HCR = "Type2")
  )

  p_bio_hat <- ggplot(df_bio_hat, aes(x = Year)) +
    ylab("Scaled abundance indices and Estimated Biomass") + xlab("") +
    geom_bar(aes(y = Biomass), stat = "identity") +
    geom_line(aes(y = Index, col = "Index*20")) +
    geom_point(aes(y = Index, col = "Index*20")) +
    scale_x_continuous(expand = c(0, 0),
                       limits = c(min(Year) - 0.5, max(Year) + 0.5),
                       breaks = seq(min(Year), max(Year), 5)) +
    scale_color_manual(values = c("Index*20" = "darkorange"), name = NULL) +
    facet_wrap(~HCR, ncol = 1) +
    theme_minimal(base_size = 12)

  print(p_bio_hat)
}

plot_mse_2(Year, h_out, t2_out)
plot_mse_estimated(Year, h_out, t2_out)

```














